<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Generator (Hair Salon)</title>
    <style>
        :root { --bg-color: #f9fafb; --card-bg: #ffffff; --text-main: #111827; --text-sub: #6b7280; --accent: #111827; --border: #e5e7eb; --radius: 12px; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--bg-color); padding: 20px; text-align: center; color: var(--text-main); line-height: 1.6; margin: 0; }
        .container { max-width: 420px; margin: 0 auto; }
        .card { background: var(--card-bg); padding: 30px 24px; border-radius: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); margin-bottom: 20px; }
        .logo-img { max-width: 280px; width: 100%; height: auto; display: block; margin: 0 auto 10px auto; }
        #shop-name-display { font-size: 0.9rem; color: var(--text-sub); margin-bottom: 30px; display: block; font-weight: normal; }
        h2 { font-size: 0.9rem; color: var(--text-sub); margin-bottom: 12px; text-align: left; font-weight: 600; display: flex; align-items: center; gap: 8px; margin-top: 0; }
        h2 span { font-size: 0.75rem; font-weight: normal; background: #f3f4f6; padding: 2px 8px; border-radius: 4px; color: #4b5563; }
        .section { margin-bottom: 36px; }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .choice-btn { padding: 12px 8px; border: 1px solid var(--border); border-radius: var(--radius); background: #fff; cursor: pointer; user-select: none; font-size: 0.9rem; font-weight: 500; color: var(--text-main); transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; min-height: 48px; width: 100%; box-sizing: border-box; }
        .choice-btn:active { transform: scale(0.98); }
        .choice-btn.selected { background-color: var(--accent); color: white; border-color: var(--accent); }
        .choice-btn.negative { color: var(--text-sub); font-size: 0.85rem; border-style: dashed; }
        .choice-btn.negative.selected { background-color: #4b5563; border-color: #4b5563; color: white; border-style: solid; }
        .free-text-area { width: 100%; padding: 16px; border: 1px solid var(--border); border-radius: var(--radius); font-size: 1rem; box-sizing: border-box; background-color: #f9fafb; resize: vertical; min-height: 100px; font-family: inherit; transition: border 0.2s; }
        .free-text-area:focus { outline: none; border-color: var(--accent); background-color: #fff; }
        .note { text-align: right; font-size: 0.75rem; color: var(--text-sub); margin-top: 6px; margin-bottom: 0; }
        #generate-btn { background: var(--accent); color: white; border: none; padding: 18px; font-size: 1rem; border-radius: 50px; cursor: pointer; width: 100%; font-weight: 600; letter-spacing: 0.05em; transition: opacity 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        #generate-btn:hover { opacity: 0.9; }
        #generate-btn:disabled { background: #d1d5db; box-shadow: none; cursor: not-allowed; }
        #result-wrapper { margin-top: 30px; text-align: left; display: none; }
        #result-area { width: 100%; min-height: 150px; border: 1px solid var(--border); background: #f9fafb; padding: 16px; border-radius: var(--radius); font-size: 1rem; color: var(--text-main); line-height: 1.7; resize: none; box-sizing: border-box; font-family: inherit; }
        #result-area:focus { outline: none; border-color: var(--accent); }
        .copy-btn { background: white; color: var(--text-main); border: 1px solid var(--border); padding: 12px; border-radius: var(--radius); cursor: pointer; width: 100%; font-weight: 600; font-size: 0.9rem; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; transition: background 0.2s; }
        .copy-btn:active { background-color: #f3f4f6; }
        .reload-link { font-size: 0.8rem; color: #6b7280; text-decoration: underline; cursor: pointer; margin-bottom: 20px; display: inline-block; }
    </style>
</head>
<body>
<div class="container">
    <div class="card">
        <img src="reviewlogo.png" alt="REVIEW GENERATOR" class="logo-img">
        <span id="shop-name-display"></span>
        <div onclick="location.reload()" class="reload-link">â†» é …ç›®ã‚’å…¥ã‚Œæ›¿ãˆã‚‹</div>
        <div class="section">
            <h2>01. æ¥åº—å›æ•°</h2>
            <div class="btn-grid" id="visit-group">
                <div class="choice-btn" onclick="toggleUnique(this)">åˆã‚ã¦</div>
                <div class="choice-btn" onclick="toggleUnique(this)">ãƒªãƒ”ãƒ¼ã‚¿ãƒ¼</div>
            </div>
        </div>
        <div class="section">
            <h2>02. æ€§åˆ¥</h2>
            <div class="btn-grid" id="gender-group">
                <div class="choice-btn" onclick="toggleUnique(this)">ç”·æ€§</div>
                <div class="choice-btn" onclick="toggleUnique(this)">å¥³æ€§</div>
                <div class="choice-btn" onclick="toggleUnique(this)">å›ç­”ã—ãªã„</div>
            </div>
        </div>
        <div class="section">
            <h2>03. ãƒ¡ãƒ‹ãƒ¥ãƒ¼ <span>è¤‡æ•°å¯</span></h2>
            <div class="btn-grid" id="menu-group">
                <div class="choice-btn" onclick="toggle(this)">ã‚«ãƒƒãƒˆ</div>
                <div class="choice-btn" onclick="toggle(this)">ã‚«ãƒ©ãƒ¼</div>
                <div class="choice-btn" onclick="toggle(this)">ãƒ‘ãƒ¼ãƒ</div>
                <div class="choice-btn" onclick="toggle(this)">ãƒˆãƒªãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆ</div>
                <div class="choice-btn" onclick="toggle(this)">ã‚·ãƒ£ãƒ³ãƒ—ãƒ¼</div>
                <div class="choice-btn" onclick="toggle(this)">ãƒ˜ãƒƒãƒ‰ã‚¹ãƒ‘</div>
            </div>
        </div>
        <div class="section">
            <h2>04. é›°å›²æ°— <span>è¤‡æ•°å¯</span></h2>
            <div class="btn-grid" id="vibe-group"></div>
        </div>
        <div class="section">
            <h2>05. æ„Ÿæƒ³ <span>è¤‡æ•°å¯</span></h2>
            <div class="btn-grid" id="impression-group"></div>
        </div>
        <div class="section">
            <h2>06. è‡ªç”±è¨˜è¿° <span>ä»»æ„</span></h2>
            <textarea id="free-text" class="free-text-area" placeholder="ä¾‹ï¼šæ‹…å½“ã€‡ã€‡ã•ã‚“&#13;&#10;ã€€ã€€ç‰¹ã«ã“ã“ãŒè‰¯ã‹ã£ãŸï¼&#13;&#10;ã€€ã€€ã“ã“ã‚’æ”¹å–„ã—ã¦ã»ã—ã„"></textarea>
            <p class="note">AIãŒã“ã®å†…å®¹ã‚’å„ªå…ˆã—ã¦ä½œæˆã—ã¾ã™</p>
        </div>
        <button id="generate-btn" onclick="generateReview()">å£ã‚³ãƒŸã‚’ä½œæˆã™ã‚‹</button>
        <div id="result-wrapper">
            <hr style="border:none; border-top:1px solid #e5e7eb; margin: 20px 0;">
            <textarea id="result-area" readonly></textarea>
            <button class="copy-btn" onclick="copyText()"><span>ğŸ“‹ ã‚³ãƒ”ãƒ¼ã—ã¦ãƒãƒƒãƒ—ã‚’é–‹ã</span></button>
        </div>
    </div>
</div>
<script>
  // Vercelä¸Šã§ã¯åŒä¸€ãƒ‰ãƒ¡ã‚¤ãƒ³ã® /api/review ãŒå‹•ãã¾ã™ï¼ˆAPIã‚­ãƒ¼ä¸è¦ï¼‰
  const API_ENDPOINT = "/api/review";

  const SHOP_LIST = {
    "takadanobaba": { name: "é«˜ç”°é¦¬å ´åº—", url: "https://g.page/r/Ca06vI3qoB4eEBM/review" },
    "shinjyukunishi": { name: "æ–°å®¿è¥¿å£åº—", url: "https://g.page/r/CVYmMLMjd4IkEBM/review" },
    "kitasenjyu": { name: "åŒ—åƒä½åº—", url: "https://g.page/r/CdMfiFO0NGXPEBM/review" },
    "ueno": { name: "ä¸Šé‡åº—", url: "https://g.page/r/CW856cOeUiPTEBM/review" },
    "kameido": { name: "äº€æˆ¸åº—", url: "https://g.page/r/CTylqAAfbYSVEBM/review" },
    "akihabara": { name: "ç§‹è‘‰åŸåº—", url: "https://g.page/r/CdSpIPYQNfI3EBM/review" },
    "shinookubo": { name: "æ–°å¤§ä¹…ä¿åº—", url: "https://g.page/r/Cek1pivUOzaAEBM/review" },
    "touyoutyou": { name: "æ±é™½ç”ºåº—", url: "https://g.page/r/CaNDj_CbOZy6EBM/review" },
    "nishinippori": { name: "è¥¿æ—¥æš®é‡Œåº—", url: "https://g.page/r/Cbp8UbQ4OX8KEBM/review" },
    "asakusa": { name: "æµ…è‰åº—", url: "https://g.page/r/CSWqNhzEEPd0EBM/review" },
    "harajyuku": { name: "åŸå®¿åº—", url: "https://g.page/r/CZi8NiHEjQ5nEBM/review" },
    "asakusabashi": { name: "æµ…è‰æ©‹åº—", url: "https://g.page/r/CWWPkVvPp1RjEBM/review" },
    "kasai": { name: "è‘›è¥¿åº—", url: "https://g.page/r/Cfq-Mx8ZLz3gEBM/review" },
    "kawaguchi": { name: "å·å£åº—", url: "https://g.page/r/CfUcADsunSmOEBM/review" },
    "senngoku": { name: "åƒçŸ³åº—", url: "https://g.page/r/CZfIQz6kLFf1EBM/review" },
    "okachimachi": { name: "å¾¡å¾’ç”ºåº—", url: "https://g.page/r/CbrMlrsshkdMEBM/review" },
    "nahakokusai": { name: "é‚£è¦‡å›½éš›é€šã‚Šåº—", url: "https://g.page/r/CR-GziBOrQuqEBM/review" },
    "EX": { name: "EXç§‹è‘‰åŸ", url: "https://g.page/r/CXS7MNm0pV-TEBM/review" },
    "kawagoe": { name: "å·è¶Šåº—", url: "https://g.page/r/CUQDRPmrzHG9EBM/review" },
    "komagome": { name: "é§’è¾¼åº—", url: "https://g.page/r/Cc1DLTOK5AdCEBM/review" },
    "kamisyakujii": { name: "ä¸ŠçŸ³ç¥äº•åº—", url: "https://g.page/r/Cce3OD9W7yL6EBM/review" }
  };

  const POOL_VIBE = ["æ¸…æ½”æ„Ÿã‚ã‚Š", "åºƒã€…ç©ºé–“", "ã‚ªã‚·ãƒ£ãƒ¬", "ç”·ã§ã‚‚æµ®ã‹ãªã„", "æ˜ã‚‹ã„åº—å†…", "æ´»æ°—ãŒã‚ã‚‹", "ãƒ†ã‚­ãƒ‘ã‚­ã—ãŸé›°å›²æ°—", "å®‰å¿ƒæ„Ÿã‚ã‚Š", "é§…ã‹ã‚‰ã‚¹ã‚°", "å…¥ã‚Šã‚„ã™ã„"];
  const POOL_IMPRESSION = ["ç´å¾—ã®å½¢", "æœŸå¾…ä»¥ä¸Š", "ç¶ºéº—ãªè‰²", "æ‰‹è§¦ã‚ŠãŒã„ã„", "é«ªãŒè»½ã„", "è²¡å¸ƒã«å„ªã—ã„", "ã¾ã¨ã¾ã‚ŠãŒè‰¯ã„", "å®Œç’§ãªãƒ©ã‚¤ãƒ³"];

  let currentShopUrl = "";
  let currentShopName = "";

  function toggle(el) { el.classList.toggle("selected"); }
  function toggleUnique(el) {
    Array.from(el.parentElement.children).forEach(sib => sib.classList.remove("selected"));
    el.classList.add("selected");
  }

  function shuffle(arr) {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function renderButtons(id, items) {
    const container = document.getElementById(id);
    if (!container) return;
    container.innerHTML = "";
    items.forEach(item => {
      const div = document.createElement("div");
      div.className = "choice-btn";
      div.innerText = item;
      div.onclick = () => toggle(div);
      container.appendChild(div);
    });
  }

  function getUniqueSelectedText(groupId, fallback = "") {
    return document.querySelector(`#${groupId} .selected`)?.innerText || fallback;
  }
  function getMultiSelectedTexts(groupId) {
    return Array.from(document.querySelectorAll(`#${groupId} .selected`)).map(el => el.innerText);
  }

  document.addEventListener("DOMContentLoaded", () => {
    const urlParams = new URLSearchParams(window.location.search);
    const shopId = urlParams.get("id") || "ueno";

    if (SHOP_LIST[shopId]) {
      currentShopUrl = SHOP_LIST[shopId].url;
      currentShopName = SHOP_LIST[shopId].name;
      const el = document.getElementById("shop-name-display");
      if (el) el.innerText = "å¯¾è±¡ï¼š" + currentShopName;
    } else {
      currentShopName = "æœªè¨­å®š";
    }

    renderButtons("vibe-group", shuffle(POOL_VIBE).slice(0, 8));
    renderButtons("impression-group", shuffle(POOL_IMPRESSION).slice(0, 8));
  });

  async function generateReview() {
    const btn = document.getElementById("generate-btn");
    const resultArea = document.getElementById("result-area");
    const resultWrapper = document.getElementById("result-wrapper");

    const gender = getUniqueSelectedText("gender-group", "å›ç­”ã—ãªã„");
    const visitType = getUniqueSelectedText("visit-group", "åˆã‚ã¦");
    const menus = getMultiSelectedTexts("menu-group");
    const vibes = getMultiSelectedTexts("vibe-group");
    const impressions = getMultiSelectedTexts("impression-group");
    const rawText = document.getElementById("free-text")?.value?.trim() || "";

    // â€œè‰¯ã‹ã£ãŸç‚¹â€ãŒç©ºã ã¨APIãŒ400ã‚’è¿”ã™ã®ã§ã€æœ€ä½é™ä½œã‚‹
    const goodPoint =
      rawText ||
      [menus.length ? `ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯${menus.join("ãƒ»")}` : "", vibes.length ? `é›°å›²æ°—ã¯${vibes.join("ãƒ»")}` : "", impressions.length ? `æ„Ÿæƒ³ã¯${impressions.join("ãƒ»")}` : ""]
        .filter(Boolean)
        .join("ã€‚");

    // é•·ã•ãƒ’ãƒ³ãƒˆ
    const lenDice = Math.random() * 100;
    let lengthHint = "150ã€œ220æ–‡å­—";
    if (lenDice < 10) lengthHint = "50æ–‡å­—ç¨‹åº¦";
    else if (lenDice < 20) lengthHint = "100æ–‡å­—ç¨‹åº¦";
    else if (lenDice < 55) lengthHint = "150æ–‡å­—ç¨‹åº¦";
    else lengthHint = "200ã€œ230æ–‡å­—";

    btn.disabled = true;
    btn.innerText = "ä½œæˆä¸­...";
    resultWrapper.style.display = "block";
    resultArea.value = "ç”Ÿæˆä¸­â€¦";

    try {
      const response = await fetch(API_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          gender,
          shopName: currentShopName,
          visitType,
          menus,
          vibes,
          impressions,
          staffName: "",     // ä½¿ã„ãŸã‘ã‚Œã°è‡ªç”±è¨˜è¿°ã‹ã‚‰æŠœãå®Ÿè£…ã‚‚å¯èƒ½
          goodPoint,
          badPoint: "",
          lengthHint
        })
      });

      const data = await response.json();
      if (!response.ok) {
        resultArea.value = `ã‚¨ãƒ©ãƒ¼: ${data?.error || response.status}`;
      } else {
        resultArea.value = data.text || "ã‚¨ãƒ©ãƒ¼: æ–‡ç« ãŒè¿”ã£ã¦ãã¾ã›ã‚“ã§ã—ãŸ";
      }
    } catch (e) {
      resultArea.value = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
    }

    btn.disabled = false;
    btn.innerText = "å£ã‚³ãƒŸã‚’ä½œæˆã™ã‚‹";
  }

  function copyText() {
    const area = document.getElementById("result-area");
    area.select();
    document.execCommand("copy");
    alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚è²¼ã‚Šä»˜ã‘ç”»é¢ã‚’é–‹ãã¾ã™ã€‚");
    if (currentShopUrl) window.open(currentShopUrl, "_blank");
  }
</script>
</body>
</html>
